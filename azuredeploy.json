{
    "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "workspaceName": {
            "type": "string",
            "metadata": {
                "description": "Specifies the name of the Azure Machine Learning workspace."
            }
        },
        "location": {
            "type": "string",
            "allowedValues": [
                "australiaeast",
                "brazilsouth",
                "canadacentral",
                "centralus",
                "eastasia",
                "eastus",
                "eastus2",
                "francecentral",
                "japaneast",
                "koreacentral",
                "northcentralus",
                "northeurope",
                "southeastasia",
                "southcentralus",
                "uksouth",
                "westcentralus",
                "westus",
                "westus2",
                "westeurope"
            ],
            "metadata": {
                "description": "Specifies the location for all resources."
            }
        },
        "storageAccountName": {
            "type": "string",
            "defaultValue": "[concat('sa',uniqueString(resourceGroup().id))]"
        },
        "keyVaultName": {
            "type": "string",
            "defaultValue": "[concat('kv',uniqueString(resourceGroup().id, parameters('location')))]"
        },
        "applicationInsightsName": {
            "type": "string",
            "defaultValue": "[concat('ai',uniqueString(resourceGroup().id))]"
        },
        "containerRegistry": {
            "type": "string",
            "defaultValue": "",
            "metadata": {
                "description": "The container registry resource id if you want to create a link to the workspace."
            }
        },
        "confidential_data": {
            "type": "string",
            "defaultValue": "false",
            "allowedValues": [
                "false",
                "true"
            ],
            "metadata": {
                "description": "Specifies that the Azure Machine Learning workspace holds highly confidential data."
            }
        },
        "gpuClusterName": {
            "type": "string",
            "defaultValue": "gpu-cluster",
            "metadata": {
                "description": "Name of the provisioned GPU cluster"
            }
        },
        "gpuVmSize": {
            "type": "string",
            "defaultValue": "STANDARD_NC6",
            "metadata": {
                "description": "SKU of nodes in provisioned GPU cluster"
            }
        },
        "gpuClusterMaxNodeCount": {
            "type": "int",
            "defaultValue": 2
        },
        "datastoreName": {
            "type": "string",
            "defaultValue": "rosettafold"
        }
    },
    "variables": {
        "tenantId": "[subscription().tenantId]",
        "storageAccount": "[resourceId(resourceGroup().name, 'Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
        "keyVault": "[resourceId(resourceGroup().name, 'Microsoft.KeyVault/vaults', parameters('keyVaultName'))]",
        "applicationInsights": "[resourceId(resourceGroup().name, 'Microsoft.Insights/components', parameters('applicationInsightsName'))]",
        "workspace": "[resourceId('Microsoft.MachineLearningServices/workspaces/', parameters('workspaceName'))]",
        "datastore": "[resourceId('Microsoft.MachineLearningServices/workspaces/datastores', parameters('workspaceName'), parameters('datastoreName'))]"
    },
    "resources": [
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2021-01-01",
            "name": "[parameters('storageAccountName')]",
            "location": "[parameters('location')]",
            "sku": {
                "name": "Standard_LRS"
            },
            "kind": "StorageV2",
            "properties": {
                "encryption": {
                    "services": {
                        "blob": {
                            "enabled": true
                        },
                        "file": {
                            "enabled": true
                        }
                    },
                    "keySource": "Microsoft.Storage"
                },
                "supportsHttpsTrafficOnly": true
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults",
            "apiVersion": "2019-09-01",
            "name": "[parameters('keyVaultName')]",
            "location": "[parameters('location')]",
            "properties": {
                "tenantId": "[variables('tenantId')]",
                "sku": {
                    "name": "standard",
                    "family": "A"
                },
                "accessPolicies": []
            }
        },
        {
            "type": "Microsoft.Insights/components",
            "apiVersion": "2018-05-01-preview",
            "name": "[parameters('applicationInsightsName')]",
            "location": "[if(or(equals(parameters('location'),'eastus2'), equals(parameters('location'),'westcentralus')),'southcentralus',parameters('location'))]",
            "kind": "web",
            "properties": {
                "Application_Type": "web"
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces",
            "apiVersion": "2020-03-01",
            "name": "[parameters('workspaceName')]",
            "location": "[parameters('location')]",
            "dependsOn": [
                "[variables('storageAccount')]",
                "[variables('keyVault')]",
                "[variables('applicationInsights')]"
            ],
            "identity": {
                "type": "systemAssigned"
            },
            "sku": {
                "tier": "enterprise",
                "name": "enterprise"
            },
            "properties": {
                "friendlyName": "[parameters('workspaceName')]",
                "storageAccount": "[variables('storageAccount')]",
                "keyVault": "[variables('keyVault')]",
                "applicationInsights": "[variables('applicationInsights')]",
                "containerRegistry": "[if(empty(parameters('containerRegistry')), json('null'), parameters('containerRegistry'))]",
                "hbiWorkspace": "[parameters('confidential_data')]"
            }
        },
        {
            "type": "Microsoft.MachineLearningServices/workspaces/computes",
            "name": "[concat(parameters('workspaceName'), '/', parameters('gpuClusterName'))]",
            "apiVersion": "2021-01-01",
            "location": "[parameters('location')]",
            "properties": {
                "computeType": "AmlCompute",
                "properties": {
                    "vmSize": "[parameters('gpuVmSize')]",
                    "scaleSettings": {
                        "minNodeCount": 0,
                        "maxNodeCount": "[parameters('gpuClusterMaxNodeCount')]"
                    }
                }
            },
            "dependsOn": [
                "[variables('workspace')]"
            ]
        },
        {
            "name": "[concat(parameters('workspaceName'), '/', parameters('datastoreName'))]",
            "type": "Microsoft.MachineLearningServices/workspaces/datastores",
            "apiVersion": "2021-03-01-preview",
            "properties": {
                "contents": {
                    "accountName": "rosettafold",
                    "containerName": "rosettafold-dependencies",
                    "contentsType": "AzureBlob",
                    "credentials": {
                        "credentialsType": "Sas",
                        "secrets": {
                            "sasToken": "sp=r&st=2021-08-03T18:55:01Z&se=3022-08-04T02:55:01Z&spr=https&sv=2020-08-04&sr=c&sig=2m%2FvkSJjW%2F860lszlsyJ6iifuv3Uw%2FSLa7Keao443VQ%3D",
                            "secretsType": "Sas"
                        }
                    },
                    "endpoint": "rosettafold.blob.core.windows.net",
                    "protocol": "https"
                },
                "description": "TODO: say something",
                "isDefault": false
            },
            "dependsOn": [
                "[variables('workspace')]"
            ]
        },
        {
            "name": "[concat(parameters('workspaceName'), '/rosettafold')]",
            "type": "Microsoft.MachineLearningServices/workspaces/batchEndpoints",
            "apiVersion": "2021-03-01-preview",
            "location": "[parameters('location')]",
            "properties": {
                "authMode": "AADToken"
            },
            "dependsOn": [
                "[variables('workspace')]"
            ]
        },
        {
            "name": "[concat(parameters('workspaceName'), '/rosettafold/2')]",
            "type": "Microsoft.MachineLearningServices/workspaces/environments/versions",
            "apiVersion": "2021-03-01-preview",
            "properties": {
                "docker": {
                    "dockerSpecificationType": "Build",
                    "dockerfile": "FROM mcr.microsoft.com\/azureml\/openmpi4.1.0-cuda11.0.3-cudnn8-ubuntu18.04\r\n\r\nRUN git clone https:\/\/github.com\/RosettaCommons\/RoseTTAFold && \\\r\n    cd RoseTTAFold && \\\r\n    #  create conda environment for RoseTTAFold\r\n    conda env create -f RoseTTAFold-linux.yml && \\\r\n    # create conda environment for pyRosetta folding & running DeepAccNet\r\n    conda env create -f folding-linux.yml && \\\r\n    # download and install third-party software if you want to run the entire modeling script (run_pyrosetta_ver.sh)\r\n    .\/install_dependencies.sh\r\n"
                },
                "description": "TODO: say something."
            },
            "dependsOn": [
                "[variables('workspace')]"
            ]
        },
        {
            "name": "[concat(parameters('workspaceName'), '/rosettafold/2')]",
            "type": "Microsoft.MachineLearningServices/workspaces/models/versions",
            "apiVersion": "2021-03-01-preview",
            "properties": {
                "datastoreId": "[variables('datastore')]",
                "path": "sample_inputs",
                "description": "TODO: something."
            },
            "dependsOn": [
                "[variables('datastore')]"
            ]
        }
    ]
}